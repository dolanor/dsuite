version: "2"

services:
  proxy:
    image: abiosoft/caddy:1.0.0
    ports:
      - "443:443"
      - "80:80"
    volumes:
      - ${HOME}/.caddy:/root/.caddy
      - ./proxy/Caddyfile:/etc/Caddyfile
    networks:
      - front
    command: -log stdout -conf=/etc/Caddyfile -agree
    restart: always

  code:
    image: gitea/gitea:1.4
    ports:
      - "22:22"
    volumes:
      - "code-data:/data"
    networks:
      - front
    restart: always

  registry:
    image: registry:2
    environment:
      REGISTRY_STORAGE_DELETE_ENABLED: "true"
    volumes:
      - "registry-data:/var/lib/registry"
    networks:
      - front
    restart: always

  drone:
    image: drone/drone:0.8.4
    environment:
      DRONE_HOST:         ${DRONE_HOST}
      DRONE_OPEN:         ${DRONE_OPEN}
      DRONE_ADMIN:        ${DRONE_ADMIN}
      DRONE_AGENT_SECRET: ${DRONE_AGENT_SECRET}
      DRONE_GITEA:        ${DRONE_GITEA}
      DRONE_GITEA_URL:    ${DRONE_GITEA_URL}
    volumes:
      - "drone-data:/var/lib/drone"
    networks:
      - front
      - drone
    restart: always

  drone-agent:
    image: drone/agent:0.8.4
    command: agent
    environment:
      DRONE_SECRET: ${DRONE_SECRET}
      DRONE_SERVER: ${DRONE_SERVER}
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
    networks:
      - drone
    restart: always

  ldap:
    image: osixia/openldap:1.1.11
    environment:
      LDAP_ORGANIZATION:    ${LDAP_ORGANIZATION}
      LDAP_DOMAIN:          ${LDAP_DOMAIN}
      LDAP_ADMIN_PASSWORD:  ${LDAP_ADMIN_PASSWORD}
      LDAP_CONFIG_PASSWORD: ${LDAP_CONFIG_PASSWORD}
    volumes:
      - "ldap-config:/etc/ldap/slapd.d"
      - "ldap-data:/var/lib/ldap"
    networks:
      - front
    restart: always

  ldapadmin:
    image: osixia/phpldapadmin:0.7.1
    environment:
      PHPLDAPADMIN_LDAP_HOSTS:   ${PHPLDAPADMIN_LDAP_HOSTS}
      PHPLDAPADMIN_SERVER_ADMIN: ${PHPLDAPADMIN_SERVER_ADMIN}
    depends_on:
      - ldap
    networks:
      - front
    restart: always

  nextcloud:
    image: nextcloud:13-apache
    environment:
      NEXTCLOUD_ADMIN_USER:     ${NEXTCLOUD_ADMIN_USER}
      NEXTCLOUD_ADMIN_PASSWORD: ${NEXTCLOUD_ADMIN_PASSWORD}
    depends_on:
      - nextcloud-db
    links:
      - nextcloud-db:db
    volumes:
      - "nextcloud-data:/var/www/html"
    networks:
      - front
      - nextcloud
    restart: always

  nextcloud-db:
    image: mariadb
    environment:
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
      MYSQL_DATABASE:      ${MYSQL_DATABASE}
      MYSQL_USER:          ${MYSQL_USER}
      MYSQL_PASSWORD:      ${MYSQL_PASSWORD}
    volumes:
      - "nextcloud-db-data:/var/lib/mysql"
    networks:
      - nextcloud
    restart: always

  mail:
    image: tvial/docker-mailserver:testing
    hostname: mail
    domainname: mydomain.com
    container_name: mail
    ports:
      - "25:25"
      - "587:587"
      - "465:465"
      - "143:143"
      - "993:993"
    volumes:
      - "mail-data:/var/mail"
      - "mail-state:/var/mail-state"
      - "./mail/config/:/tmp/docker-mailserver/"
      - "${HOME}/.caddy/acme/acme-v01.api.letsencrypt.com/sites/mail.mydomain.com/mail.mydomain.com.crt:/etc/letsencrypt/live/mail.mydomain.com/fullchain.pem"
      - "${HOME}/.caddy/acme/acme-v01.api.letsencrypt.com/sites/mail.mydomain.com/mail.mydomain.com.crt:/etc/letsencrypt/live/mail.mydomain.com/cert.pem"
      - "${HOME}/.caddy/acme/acme-v01.api.letsencrypt.com/sites/mail.mydomain.com/mail.mydomain.com.key:/etc/letsencrypt/live/mail.mydomain.com/privkey.pem"
    environment:
      ENABLE_SPAMASSASSIN:        ${ENABLE_SPAMASSASSIN}
      ENABLE_CLAMAV:              ${ENABLE_CLAMAV}
      ENABLE_FAIL2BAN:            ${ENABLE_FAIL2BAN}
      ENABLE_POSTGREY:            ${ENABLE_POSTGREY}
      ENABLE_SASLAUTHD:           ${ENABLE_SASLAUTHD}
      ENABLE_LDAP:                ${ENABLE_LDAP}
      SSL_TYPE:                   ${SSL_TYPE}
      ONE_DIR:                    ${ONE_DIR}
      DMS_DEBUG:                  ${DMS_DEBUG}
      LDAP_SERVER_HOST:           ${LDAP_SERVER_HOST}
      LDAP_SEARCH_BASE:           ${LDAP_SEARCH_BASE}
      LDAP_BIND_DN:               ${LDAP_BIND_DN}
      LDAP_BIND_PW:               ${LDAP_BIND_PW}
      LDAP_QUERY_FILTER_USER:     ${LDAP_QUERY_FILTER_USER}
      LDAP_QUERY_FILTER_GROUP:    ${LDAP_QUERY_FILTER_GROUP}
      LDAP_QUERY_FILTER_ALIAS:    ${LDAP_QUERY_FILTER_ALIAS}
      LDAP_QUERY_FILTER_DOMAIN:   ${LDAP_QUERY_FILTER_DOMAIN}
      DOVECOT_PASS_FILTER:        ${DOVECOT_PASS_FILTER}
      DOVECOT_USER_FILTER:        ${DOVECOT_USER_FILTER}
      DOVECOT_USER_ATTRS:         ${DOVECOT_USER_ATTRS}
      SASLAUTHD_MECHANISMS:       ${SASLAUTHD_MECHANISMS}
      SASLAUTHD_LDAP_SERVER:      ${SASLAUTHD_LDAP_SERVER}
      SASLAUTHD_LDAP_SEARCH_BASE: ${SASLAUTHD_LDAP_SEARCH_BASE}
      SASLAUTHD_LDAP_BIND_DN:     ${SASLAUTHD_LDAP_BIND_DN}
      SASLAUTHD_LDAP_PASSWORD:    ${SASLAUTHD_LDAP_PASSWORD}
      SASLAUTHD_LDAP_FILTER:      ${SASLAUTHD_LDAP_FILTER}
      POSTMASTER_ADDRESS:         ${POSTMASTER_ADDRESS}
    cap_add:
      - NET_ADMIN
      - SYS_PTRACE
    networks:
      - front
    restart: always

networks:
  front:
    driver: bridge
  nextcloud:
  drone:

volumes:
  code-data:
  registry-data:
  drone-data:
  mail-data:
  mail-state:
  nextcloud-data:
  nextcloud-db-data:
  ldap-data:
  ldap-config:
